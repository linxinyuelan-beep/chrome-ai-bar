# 对话历史功能测试指南

## 功能概述

对话历史功能已经完全实现，现在包括：

1. **自动保存聊天会话** - 每次发送消息、收到AI回复、清空对话时都会自动保存
2. **智能标题生成** - 基于第一条用户消息或摘要上下文自动生成描述性标题
3. **历史记录管理** - 支持加载、查看、删除历史对话
4. **上下文恢复** - 从历史记录中选择对话时会恢复相关的摘要上下文

## 测试步骤

### 1. 基本对话功能测试

1. **生成摘要并开始对话**
   - 在任意网页生成页面摘要或选中内容摘要
   - 点击"开始聊天"按钮
   - 验证对话界面显示摘要内容作为第一条消息
   - 发送一条用户消息，例如："请详细解释这个内容"
   - 验证AI能够正确回复

2. **验证自动保存功能**
   - 点击右上角历史图标
   - 切换到"对话历史"标签页
   - 确认刚才的对话已经出现在历史列表中
   - 验证对话标题基于摘要内容或第一条用户消息生成

### 2. 对话历史管理测试

2. **查看历史对话**
   - 在历史面板中点击任一对话记录
   - **验证直接进入聊天界面**（不是摘要页面）
   - 确认所有消息（包括摘要上下文）都能正确显示
   - 验证能够继续在该对话中发送新消息
   - 确认"返回摘要"按钮可用（如果有相关摘要）

2. **删除历史对话**
   - 在对话历史列表中点击垃圾桶图标
   - 验证对话从列表中消失
   - 确认删除操作不影响其他对话

3. **搜索历史对话**
   - 在搜索框中输入关键词
   - 验证搜索结果准确匹配对话标题内容
   - 测试中文和英文关键词搜索

### 3. 多对话会话测试

1. **创建多个对话**
   - 在不同网页生成多个摘要
   - 为每个摘要开始独立的对话
   - 发送不同类型的消息以测试标题生成

2. **切换对话会话**
   - 在历史面板中选择不同的对话
   - 验证每个对话的上下文独立性
   - 确认消息历史不会混淆

### 4. 智能标题生成测试

1. **基于摘要的标题**
   - 从摘要开始对话，验证标题包含摘要标题内容
   - 测试长标题的截断处理（>30字符）

2. **基于用户消息的标题**
   - 创建不包含摘要的对话会话
   - 发送第一条用户消息
   - 验证标题基于用户消息内容生成

### 5. 快捷回复测试

1. **使用快捷回复**
   - 在对话界面使用预设的快捷回复按钮
   - 验证快捷回复会正确发送并获得AI响应
   - 确认快捷回复的对话也会被保存到历史

### 6. 异常情况测试

1. **网络错误处理**
   - 在无网络环境下尝试发送消息
   - 验证错误消息正确显示并保存到对话历史

2. **存储限制测试**
   - 创建大量对话（>50个）
   - 验证存储管理器正确限制历史记录数量
   - 确认旧对话被正确清理

## 验证要点

- ✅ **自动保存**: 每次消息交互都应自动保存到 Chrome Storage
- ✅ **标题生成**: 对话标题应该有意义且描述性强
- ✅ **历史恢复**: 从历史记录选择对话时应直接进入聊天界面并完整恢复上下文
- ✅ **搜索功能**: 支持按标题内容搜索历史对话
- ✅ **删除功能**: 能够单独删除指定对话而不影响其他记录
- ✅ **数量限制**: 历史记录应受到合理限制（50个对话）
- ✅ **错误处理**: 保存失败时不应影响用户体验

## 开发者调试

在浏览器开发者工具中可以查看：

```javascript
// 查看所有保存的对话
chrome.storage.local.get('chats').then(console.log);

// 查看所有保存的摘要
chrome.storage.local.get('summaries').then(console.log);

// 清空所有数据（谨慎使用）
// chrome.storage.local.clear();
```

## 注意事项

1. **权限要求**: 确保扩展有 `storage` 权限
2. **存储配额**: Chrome Storage Local 有 5MB 限制
3. **版本兼容**: 功能需要 Chrome 116+ 支持 Side Panel API
4. **数据持久**: 历史记录在扩展重新加载后应该保持